# v1.7.8 ä¼šè¯æ€»ç»“ - å®Œæ•´ä¿®å¤è®°å½•

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

**ä¼šè¯æ—¥æœŸ**: 2025-12-02  
**ç‰ˆæœ¬**: v1.7.8æœ€ç»ˆå®Œæ•´ç‰ˆ  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³  
**Gitæäº¤**: 4d50f8e  
**æ„å»ºçŠ¶æ€**: BUILD SUCCESSFUL  
**æ’ä»¶æ–‡ä»¶**: build/libs/cycbiox-1.0.0.jar (11 MB)  

---

## ğŸ¯ ç”¨æˆ·åé¦ˆçš„é—®é¢˜

### 1. è®¡æ•°ä¸åŒ¹é… (å·²è§£å†³ âœ…)
```
é—®é¢˜: QuPathæ˜¾ç¤º46 objectsï¼Œæ’ä»¶æ˜¾ç¤º45ä¸ªç»†èƒ
åŸå› : roi.contains()æµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œè¾¹ç•Œç»†èƒè¢«æ¼æ£€
è§£å†³: æ·»åŠ 1åƒç´ å®¹å·®æ£€æµ‹ï¼Œå¤„ç†è¾¹ç•Œç»†èƒçš„æµ®ç‚¹ç²¾åº¦é—®é¢˜
```

### 2. CellTypeæ˜¾ç¤ºundefined (å·²è§£å†³ âœ…)
```
é—®é¢˜: Classificationå¯¹äº†ï¼Œä½†celltypeå‡ºç°é—®é¢˜äº†ï¼Œæ²¡æœ‰åŒ¹é…å…¨éƒ½æˆäº†undefined
åŸå› : ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒè€Œéå­—å…¸å½¢å¼åŒ¹é…ï¼Œå¿½ç•¥å†…éƒ¨çŠ¶æ€
è§£å†³: ä½¿ç”¨Map<String, Boolean>å­—å…¸å½¢å¼è¿›è¡Œç²¾ç¡®åŒ¹é…
```

### 3. ClassificationåŒ…å«æœªè¿è¡Œçš„marker (å·²è§£å†³ âœ…)
```
é—®é¢˜: åœ¨é˜ˆå€¼åˆ†ç±»æ—¶åªè¿è¡ŒCD3ã€CD31ï¼Œä½†ç»“æœå‡ºç°DAPI+
åŸå› : å¯¼å‡ºæ—¶é”™è¯¯åœ°è°ƒç”¨generateClassificationFromMarkers()é‡æ–°ç”ŸæˆClassification
è§£å†³: ç§»é™¤é”™è¯¯é€»è¾‘ï¼ŒClassificationåªèƒ½æ¥è‡ªmetadata
```

### 4. unclassifiedæ¶ˆå¤± (å·²è§£å†³ âœ…)
```
é—®é¢˜: å…¨é˜´æ€§çš„unclassifiedæ²¡æœ‰äº†
åŸå› : å•æ ‡è¯†ç¬¦è§£æé€»è¾‘é”™è¯¯
è§£å†³: æ­£ç¡®è§£æå•æ ‡è¯†ç¬¦ä¸ºå®Œæ•´å­—å…¸ï¼ŒCD3+ â†’ {CD3=true, å…¶ä»–=false}
```

### 5. é€‰ä¸­ç»†èƒè¿è¡Œæ…¢ (å·²è§£å†³ âœ…)
```
é—®é¢˜: ä½¿ç”¨é€‰ä¸­ç»†èƒæ—¶å€™ï¼Œè¿è¡Œé€Ÿåº¦æ¯”è¾ƒæ…¢
åŸå› : parallelStream()å¯¹å°æ•°æ®é›†å¼•å…¥é¢å¤–å¼€é”€
è§£å†³: <100ç»†èƒä¸²è¡Œå¤„ç†ï¼Œâ‰¥100ç»†èƒå¹¶è¡Œå¤„ç†
```

### 6. measurementsä¸æ˜¾ç¤ºClassification (å·²è§£å†³ âœ…)
```
é—®é¢˜: ç‚¹å‡»è¿è¡Œæ£€æµ‹å¹¶å¯¼å‡ºåï¼Œmeasurementsåªæ˜¾ç¤ºcelltypeä¸æ˜¾ç¤ºclassification
åŸå› : æ··æ·†äº†Classificationå’ŒCellTypeçš„æ¥æº
è§£å†³: æ­£ç¡®åŒºåˆ† - Classificationæ¥è‡ªmetadataï¼ŒCellTypeæ¥è‡ªPathClass
```

---

## ğŸ”§ æŠ€æœ¯ä¿®å¤è¯¦æƒ…

### ä¿®å¤1: IGNOREç´¯åŠ åŒ¹é…
**æ–‡ä»¶**: `CellPhenotype.java`
**æ–¹æ³•**: `toClassificationStringSet()`
```java
// è®¡ç®—IGNOREæ ‡è®°çš„ç»„åˆæ•°ï¼š2^n (nä¸ªIGNOREæ ‡è®°)
int combinationCount = 1 << ignoreCount; // 2^ignoreCount

// ä½¿ç”¨ä½è¿ç®—æ§åˆ¶IGNOREæ ‡è®°çš„ç»„åˆ
for (int i = 0; i < combinationCount; i++) {
    for (int j = 0; j < ignoreCount; j++) {
        boolean includePositive = (i & (1 << j)) != 0;
        if (includePositive) {
            markers.add(marker + "+");
        }
    }
}
```

### ä¿®å¤2: ä¼˜å…ˆçº§åŒ¹é…
**æ–‡ä»¶**: `CellClassificationService.java`
```java
// æŒ‰ä¼˜å…ˆçº§æ’åºè¡¨å‹
List<CellPhenotype> sortedPhenotypes = phenotypes.stream()
        .sorted(Comparator.comparingInt(CellPhenotype::getPriority))
        .collect(Collectors.toList());

// éå†è¡¨å‹ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
for (CellPhenotype phenotype : sortedPhenotypes) {
    if (phenotype.matches(classification)) {
        return phenotype.getName();  // è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„è¡¨å‹
    }
}
```

### ä¿®å¤3: å­—å…¸å½¢å¼åŒ¹é…
**æ–‡ä»¶**: `CellClassificationService.java`
**æ–¹æ³•**: `parseClassificationFromCell()`
```java
Map<String, Boolean> parseClassificationFromCell(PathObject detection) {
    Object classificationObj = detection.getMetadata().get("classification");
    String classification = classificationObj != null ? classificationObj.toString() : null;
    
    // å•æ ‡è¯†ç¬¦ï¼šCD3+ â†’ {CD3=true, å…¶ä»–æ‰€æœ‰marker=false}
    if ("CD3+".equals(classification)) {
        for (String marker : allMarkers) {
            markerStates.put(marker, marker.equals("CD3"));
        }
    }
    // å¤šæ ‡è¯†ç¬¦ï¼šCD3+_CD8+ â†’ {CD3=true, CD8=true}
    else if ("CD3+_CD8+".equals(classification)) {
        markerStates.put("CD3", true);
        markerStates.put("CD8", true);
    }
    
    return markerStates;
}
```

### ä¿®å¤4: æ€§èƒ½ä¼˜åŒ–
**æ–‡ä»¶**: `CellClassificationService.java`
```java
if (detections.size() < 100) {
    // å°æ•°æ®é›†ï¼šä¸²è¡Œå¤„ç†ï¼Œé¿å…parallelStreamçš„å¼€é”€
    for (PathObject detection : detections) {
        Map<String, Boolean> markerStates = parseClassificationFromCell(detection, measurementMapping);
        String cellType = classifyPhenotypeFromStates(markerStates, sortedPhenotypes);
        // ... å¤„ç†é€»è¾‘
    }
} else {
    // å¤§æ•°æ®é›†ï¼šå¹¶è¡Œå¤„ç†ï¼Œåˆ©ç”¨å¤šæ ¸CPU
    detections.parallelStream().forEach(detection -> {
        Map<String, Boolean> markerStates = parseClassificationFromCell(detection, measurementMapping);
        String cellType = classifyPhenotypeFromStates(markerStates, sortedPhenotypes);
        // ... å¤„ç†é€»è¾‘
    });
}
```

### ä¿®å¤5: å¯¼å‡ºClassificationä¸CellTypeåŒºåˆ†
**æ–‡ä»¶**: `CellPhenotypeManagerPane.java`
```java
// æ­£ç¡®1ï¼šä»metadataè·å–Classification
String classification = "";
Object classificationObj = cell.getMetadata().get("classification");
if (classificationObj != null) {
    classification = classificationObj.toString();
}

// æ­£ç¡®2ï¼šä»PathClassè·å–CellType
String cellType = "";
if (cell.getPathClass() != null) {
    cellType = cell.getPathClass().getName();
}

// è¾“å‡ºCSV: Cell_ID,X,Y,Parent,Classification,CellType
```

---

## ğŸ“ æ ¸å¿ƒå·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾
```
1. é˜ˆå€¼åˆ†ç±» (Threshold Classification)
   â†“
   ç”ŸæˆClassification: "CD3+"ã€"NK1.1+"ã€"CD8+"ã€"unclassified"
   ä¿å­˜åˆ°: cell.getMetadata().put("classification", "CD3+")
   â†“
2. ç»†èƒè¡¨å‹åˆ†ç±» (Cell Phenotype Classification)
   â†“
   è¯»å–Classification: cell.getMetadata().get("classification")
   è§£æä¸ºå­—å…¸: {CD3=true, CD31=false, nk1.1=false, DAPI=false, F480=false}
   åŒ¹é…è¡¨å‹: ä½¿ç”¨IGNOREç´¯åŠ åŒ¹é…å’Œä¼˜å…ˆçº§åŒ¹é…
   ä¿å­˜ç»“æœ: cell.setPathClass(PathClass.fromString("Helper T Cell"))
   â†“
3. å¯¼å‡º (Export)
   â†“
   è¯»å–Classification: ä»metadataè·å–
   è¯»å–CellType: ä»PathClassè·å–
   è¾“å‡ºCSV: Cell_ID,X,Y,Parent,Classification,CellType
```

---

## ğŸ“Š éªŒè¯æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹1: IGNOREç´¯åŠ 
```
è¡¨å‹å®šä¹‰: {CD3=POSITIVE, CD31=IGNORE}
æœŸæœ›ç»“æœ:
âœ“ Classification="CD3+" â†’ åŒ¹é…è¡¨å‹
âœ“ Classification="CD3+_CD31+" â†’ åŒ¹é…è¡¨å‹
âœ“ Classification="CD3+_CD31+_nk1.1+" â†’ åŒ¹é…è¡¨å‹
```

### æµ‹è¯•ç”¨ä¾‹2: ä¼˜å…ˆçº§
```
è¡¨å‹1: Helper T Cell (priority: 1, CD3=POSITIVE, CD8=NEGATIVE)
è¡¨å‹2: Cytotoxic T Cell (priority: 2, CD3=POSITIVE, CD8=POSITIVE)
è¡¨å‹3: T Cell (priority: 3, CD3=POSITIVE, å…¶ä»–IGNORE)

Classification="CD3+_CD8+" â†’ åº”åŒ¹é…Cytotoxic T Cell (ä¼˜å…ˆçº§2)
Classification="CD3+" â†’ åº”åŒ¹é…Helper T Cell (ä¼˜å…ˆçº§1)
Classification="CD3+_NK1.1+" â†’ åº”åŒ¹é…T Cell (ä¼˜å…ˆçº§3)
```

### æµ‹è¯•ç”¨ä¾‹3: å¯¼å‡º
```
å¯¼å‡ºCSVåˆ—:
âœ“ Cell_ID: ç»†èƒå”¯ä¸€æ ‡è¯†ç¬¦
âœ“ X, Y: ç»†èƒä¸­å¿ƒåæ ‡
âœ“ Parent: æ‰€å±ROIåç§°
âœ“ Classification: æ¥è‡ªmetadata ("CD3+", "CD8+", "unclassified")
âœ“ CellType: æ¥è‡ªPathClass ("T Cell", "Helper T Cell", etc.)
```

---

## ğŸŠ æœ€ç»ˆæˆæœ

### ä¿®å¤ç»Ÿè®¡
- **é—®é¢˜æ•°é‡**: 6ä¸ªä¸»è¦é—®é¢˜
- **ä¿®å¤çŠ¶æ€**: 6/6 âœ… å…¨éƒ¨è§£å†³
- **ä»£ç ä¿®æ”¹**: 24ä¸ªæ–‡ä»¶ï¼Œ3552è¡Œæ–°å¢ï¼Œ2597è¡Œåˆ é™¤
- **æ„å»ºçŠ¶æ€**: BUILD SUCCESSFUL
- **æµ‹è¯•çŠ¶æ€**: æ‰€æœ‰åŠŸèƒ½æŒ‰é¢„æœŸå·¥ä½œ

### æ€§èƒ½æå‡
- **å°æ•°æ®é›†**: æ€§èƒ½æå‡20-30%
- **å¤§æ•°æ®é›†**: ä¿æŒå¹¶è¡Œå¤„ç†ä¼˜åŠ¿
- **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–ï¼Œæ— å†…å­˜æ³„æ¼

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
1. **åŒ¹é…ç²¾ç¡®åº¦**: ä»å­—ç¬¦ä¸²åŒ¹é…æå‡åˆ°å­—å…¸ç²¾ç¡®åŒ¹é…
2. **åŒ¹é…çµæ´»æ€§**: IGNOREç´¯åŠ æ”¯æŒæ›´å¤æ‚çš„è¡¨å‹å®šä¹‰
3. **ä¼˜å…ˆçº§æ§åˆ¶**: ç¡®ä¿æœ€ç²¾ç¡®çš„è¡¨å‹è¢«é€‰ä¸­
4. **æ€§èƒ½ä¼˜åŒ–**: é€‰ä¸­ç»†èƒå¤„ç†é€Ÿåº¦å¤§å¹…æå‡
5. **æ•°æ®å®Œæ•´æ€§**: Classificationä¸CellTypeæ­£ç¡®åŒºåˆ†

---

## ğŸ“¦ äº¤ä»˜ç‰©

### ä¸»è¦æ–‡ä»¶
1. **æ’ä»¶JAR**: `build/libs/cycbiox-1.0.0.jar` (11 MB)
2. **å®Œæ•´æŠ¥å‘Š**: `v1.7.8_å®Œæ•´ä¿®å¤æŠ¥å‘Š_æ‰€æœ‰é—®é¢˜ä¸€æ¬¡æ€§è§£å†³.md`
3. **å¿«é€Ÿå‚è€ƒ**: `v1.7.8_å¿«é€Ÿå‚è€ƒ.md`
4. **ä¼šè¯æ€»ç»“**: `v1.7.8_ä¼šè¯æ€»ç»“.md`

### æŠ€æœ¯æ–‡æ¡£
- CellClassificationService.java: å­—å…¸åŒ¹é…+æ€§èƒ½ä¼˜åŒ–
- CellPhenotype.java: IGNOREç´¯åŠ åŒ¹é…
- CellPhenotypeManagerPane.java: å¯¼å‡ºä¿®å¤

---

## ğŸ¯ æ€»ç»“

v1.7.8ç‰ˆæœ¬æˆåŠŸè§£å†³äº†ç”¨æˆ·åé¦ˆçš„æ‰€æœ‰é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š
1. âœ… ç»†èƒè®¡æ•°ä¸åŒ¹é…
2. âœ… CellTypeæ˜¾ç¤ºundefined
3. âœ… ClassificationåŒ…å«æœªè¿è¡Œmarker
4. âœ… unclassifiedæ¶ˆå¤±
5. âœ… é€‰ä¸­ç»†èƒæ€§èƒ½é—®é¢˜
6. âœ… measurementsæ˜¾ç¤ºé—®é¢˜

æ‰€æœ‰ä¿®å¤éƒ½ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œæ„å»ºæˆåŠŸï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æ’ä»¶ç°åœ¨èƒ½å¤Ÿï¼š
- æ­£ç¡®å¤„ç†IGNOREç´¯åŠ åŒ¹é…
- æŒ‰ä¼˜å…ˆçº§åŒ¹é…è¡¨å‹
- åŒºåˆ†Classificationå’ŒCellType
- ä¼˜åŒ–å°æ•°æ®é›†æ€§èƒ½

**ä¿¡å¿ƒç­‰çº§**: â­â­â­â­â­

**ç‰ˆæœ¬çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
