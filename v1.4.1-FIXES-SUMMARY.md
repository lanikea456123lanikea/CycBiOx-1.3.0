# CycBiOx v1.4.1 修复报告

## 修复内容

### 问题1: Cellpose测量值格式修复 ✅

**问题描述**: Cellpose的测量值格式与QuPath Detection不一致

**修复内容**:
- 将Cellpose测量值格式从 `"CD68: Nucleus: Mean"` 改为与QuPath Detection相同的格式 `"Nucleus: CD68 mean"`
- 使用空格分隔和小写字母
- 保持15个测量值: Nucleus(5) + Cytoplasm(5) + Cell(5)

**修复位置**: `CellPhenotypeManagerPane.java:407-426`

**示例测量值**:
```
"Nucleus: CD68 mean"
"Nucleus: CD68 std dev"
"Nucleus: CD68 max"
"Nucleus: CD68 min"
"Cell: CD68 mean"
"Cell: CD68 std dev"
"Cell: CD68 max"
"Cell: CD68 min"
"Cytoplasm: CD68 mean"
"Cytoplasm: CD68 std dev"
"Cytoplasm: CD68 max"
"Cytoplasm: CD68 min"
```

### 问题2: 圆形ROI细胞计数不一致修复 ✅

**问题描述**: 选中细胞如果ROI为圆形，和QuPath原生展示的细胞个数不一致

**问题根因**: 
- 原来的ROI过滤逻辑只检查细胞中心点是否在ROI内
- 对于圆形ROI，这可能导致边界上的细胞被错误排除或包含

**修复内容**:
- 增加边界框相交判断
- 使用三阶段检查：
  1. 检查细胞中心点是否在ROI内
  2. 获取细胞ROI的边界框
  3. 获取ROI的边界框
  4. 进行AABB（轴对齐边界框）相交测试
- 如果中心点在ROI内或边界框相交，则认为细胞在ROI内

**修复位置**: `CellPhenotypeManagerPane.java:6510-6558`

**核心逻辑**:
```java
// 1. 检查中心点
boolean centerInside = roi.contains(cellX, cellY);

// 2. AABB相交测试
boolean intersects = !(cellMaxX < roiMinX ||
                       cellMinX > roiMaxX ||
                       cellMaxY < roiMinY ||
                       cellMinY > roiMaxY);

// 3. 综合判断
if (centerInside || intersects) {
    cellsInROI.add(cell);
}
```

## 构建状态

✅ 编译成功
✅ 无编译错误
⚠️ 12个警告（类型转换警告，非关键）

## 测试建议

1. **Cellpose测量值测试**:
   - 选择Cellpose分割模型
   - 检查测量值下拉框中的格式
   - 验证格式�� "Nucleus: CD68 mean" 而非 "CD68: Nucleus: Mean"

2. **圆形ROI测试**:
   - 在QuPath中创建圆形ROI
   - 选择该ROI区域
   - 检查选中的细胞数量是否与QuPath原生显示一致

## 版本信息

- **版本**: v1.4.1
- **修复日期**: 2025-11-25
- **状态**: 已完成并编译成功

