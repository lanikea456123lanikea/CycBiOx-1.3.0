# CycBiOx v1.3.0 Release Notes

**发布日期**: 2025-01-07
**构建状态**: ✅ BUILD SUCCESSFUL

---

## 🎯 重大更新

### 1. **Classification和CellType独立存储**

使用QuPath原生的**层级PathClass系统**实现两者独立存储和显示。

#### Load Classifier（分类）
- **按钮**: "Load Classifier"
- **PathClass格式**: `"Classification: CD3+_CD4+_CD8-"`
- **Hierarchy显示**: Classification组，带独立伪彩
- **功能**: 基于阈值的二元分类（阳性/阴性）

#### Cell Classification（表型）
- **按钮**: "运行检测并导出数据"
- **PathClass格式**: `"CellType: Helper T Cell"`
- **Hierarchy显示**: CellType组，带独立伪彩
- **功能**: 基于表型规则的生物学分类

#### CSV导出（双列独立）
```csv
Cell_ID,X,Y,Parent,Classification,CellType
cell_1,100.5,200.3,ROI_1,CD3+_CD4+_CD8-,Helper T Cell
cell_2,150.2,250.8,ROI_1,CD3+_CD4-_CD8+,Cytotoxic T Cell
```

---

### 2. **精准匹配机制（删除部分匹配）**

#### 修改前（v1.2.0）
- 使用`contains()`进行部分匹配
- 可能误匹配相似名称

#### 修改后（v1.3.0）
- 使用`equals()`进行精准匹配
- Token完全相等匹配算法
- **支持Unicode特殊字符**（γ、α、β等）

#### 示例
```java
// ❌ 旧方法：部分匹配
if (actual.toLowerCase().contains(displayName.toLowerCase())) {
    return actual;  // "CD3"可能匹配到"CD31"
}

// ✅ 新方法：精准匹配
String[] tokens = measurementName.split("[:\\s]+");
for (String token : tokens) {
    if (token.equals(channelName)) {  // 必须完全相等
        return measurementName;
    }
}
```

---

### 3. **全量通道识别（删除DAPI特殊处理）**

#### 修改前（v1.2.0）
- 自动过滤DAPI通道
- C1优先级最低
- 分析通道从C2开始

#### 修改后（v1.3.0）
- **所有通道一视同仁**
- C1优先级最高
- 不跳过任何通道

#### 通道优先级
```
v1.2.0: C2 > C3 > C4 > C1 > DAPI
v1.3.0: C1 > C2 > C3 > C4 > C5
```

---

## 📝 修改文件清单

### 核心修改
1. **`ColorUtils.java`**
   - 新增`getClassificationColor()`
   - 新增`createOrGetClassificationPathClass()`
   - 新增`applyClassificationColors()`
   - 修改`applyCellTypeColors()`使用层级格式

2. **`CellClassificationService.java`**
   - 新增`applyClassificationResultsOnly()`
   - 新增`applyCellTypeResultsOnly()`
   - 新增支持displayMode的重载方法

3. **`MeasurementUtils.java`**
   - 删除模糊匹配逻辑
   - 新增`findExactUnicodeMatch()`
   - 修改通道优先级（C1最高）

4. **`CellPhenotypeAPI.java`**
   - 删除DAPI过滤：`.filter(name -> !name.toLowerCase().contains("dapi"))`
   - 全量返回所有通道

5. **`ChannelInfoManager.java`**
   - 删除DAPI跳过逻辑
   - 删除`analysisChannelIndex`偏移量

6. **`DirectChannelFixer.java`**
   - 修改优先级顺序为C1 > C2 > C3 > C4

7. **`CellPhenotypeManagerPane.java`**
   - Load Classifier使用`ColorUtils.createOrGetClassificationPathClass()`
   - 添加ColorUtils导入

### 文档更新
- ✅ `CLAUDE.md` - 技术文档更新
- ✅ `项目需求文档.md` - 需求文档更新
- ✅ `CHANGES_SUMMARY.md` - 详细修改总结
- ✅ `IMPLEMENTATION_PLAN.md` - 实现方案文档

---

## 🚀 使用指南

### 基本流程

1. **设置阈值**
   - 在"阈值策略配置"区域调整各通道阈值
   - 支持Manual手动或Auto自动模式

2. **运行Load Classifier**
   - 点击"Load Classifier"按钮
   - Hierarchy显示：`Classification: xxx`（带伪彩）
   - 生成组合标签（如"CD3+_CD4+_CD8-"）

3. **定义表型规则**
   - 在"细胞分类管理"区域定义表型
   - 设置marker状态（阳性/阴性/无关）
   - 调整优先级

4. **运行Cell Classification**
   - 点击"运行检测并导出数据"按钮
   - Hierarchy显示：`CellType: xxx`（带伪彩）
   - 生成表型名称（如"Helper T Cell"）
   - 自动导出CSV文件

### 伪彩切换

- **查看Classification伪彩**：运行Load Classifier后查看Hierarchy
- **查看CellType伪彩**：运行Cell Classification后查看Hierarchy
- 两者会覆盖PathClass，最后运行的按钮决定当前显示

### CSV导出数据

CSV文件包含两列独立数据：
- **Classification列**：从`Classification_Info` measurement读取
- **CellType列**：从`CellType_Info` measurement读取

---

## ⚠️ 注意事项

1. **Unicode字符支持**
   - 通道名称可以使用γ、α、β等特殊字符
   - 确保文件编码为UTF-8

2. **DAPI通道**
   - v1.3.0不再自动过滤DAPI
   - 如果不需要DAPI参与分类，请在阈值配置中取消勾选

3. **PathClass覆盖**
   - Load Classifier和Cell Classification会设置不同的PathClass
   - 最后运行的按钮决定Hierarchy当前显示的分类
   - 两者数据都存储在measurements中，不会丢失

4. **CSV导出**
   - 确保先运行Load Classifier，再运行Cell Classification
   - 这样CSV文件才能包含完整的双列数据

---

## 🐛 已知问题

**无**

---

## 🔄 从v1.2.0升级

### 兼容性
- ✅ 完全向后兼容
- ✅ 老配置文件可以正常加载
- ✅ 不影响现有项目

### 新功能使用
1. 替换旧的JAR文件：`cycbiox-1.0.0.jar`
2. 重启QuPath
3. 打开CycBiOx插件
4. 按照新的流程使用（先Load Classifier，后Cell Classification）

---

## 📚 相关文档

- [CHANGES_SUMMARY.md](CHANGES_SUMMARY.md) - 详细修改总结
- [IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md) - 实现方案
- [CLAUDE.md](CLAUDE.md) - 技术文档
- [项目需求文档.md](项目需求文档.md) - 需求文档

---

## 💻 构建信息

```
Gradle: 8.4
Java: 21
QuPath: 0.6.0+
Build Time: ~5s
Warnings: 11 (unchecked cast，可忽略)
```

---

## 🙏 致谢

感谢所有测试人员和用户的反馈！

---

**CycBiOx开发团队**
2025-01-07
